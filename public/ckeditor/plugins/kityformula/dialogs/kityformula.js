CKEDITOR.dialog.add("kityformulaDialog",function(b){var a="kity_"+b.id;return{title:"公式编辑器",minWidth:400,minHeight:200,contents:[{id:"tab-kity",label:"公式编辑器",elements:[{type:"html",html:'\x3cdiv style\x3d"width:800px;height:400px;"\x3e\x3ciframe id\x3d"'+a+'" style\x3d"width:800px;height:400px;" frameborder\x3d"no" src\x3d"'+CKEDITOR.basePath+'plugins/kityformula/dialogs/kityFormulaDialog.html"\x3e\x3c/iframe\x3e\x3c/div\x3e'}]}],onOk:function(){var c=getIFrame(a).contentWindow;c.kfe.execCommand("get.image.data",
function(a){var d=c.kfe.execCommand("get.source"),e=b.document.createElement("img");e.setAttribute("class","kfformula");e.setAttribute("src",a.img);e.setAttribute("data-latex",d);if("\\placeholder "!==d){b.insertElement(e);var d=CKEDITOR.fileTools,g=d.getUploadUrl(b.config,"image");d.addUploadWidget(b,"uploadimage",{supportedTypes:/image\/(jpeg|png|gif|bmp|emf)/,uploadUrl:g});var f=a.img.match(/image\/([a-z]+?);/i),f=f&&f[1]||"jpg";a=b.uploadRepository.create(a.img,getUniqueImageFileName(f));a.upload(g);
a.on("uploaded",function(a){e.setAttribute("src",a.sender.url)});d.bindNotifications(b,a)}})},onShow:function(){var c=b.getSelection().getStartElement();c&&"kfformula"===c.getAttribute("class")?getIFrame(a).contentWindow.location.assign(CKEDITOR.basePath+"plugins/kityformula/dialogs/kityFormulaDialog.html?latex\x3d"+c.getAttribute("data-latex")):getIFrame(a).contentWindow.location.assign(CKEDITOR.basePath+"plugins/kityformula/dialogs/kityFormulaDialog.html?_\x3d"+(new Date).getTime())}}});
function getIFrame(b){return document.frames?document.frames[b]:document.getElementById(b)}var uniqueNameCounter=0;function padNumber(b){9>=b&&(b="0"+b);return String(b)}function getUniqueImageFileName(b){var a=new Date,a=[a.getFullYear(),a.getMonth()+1,a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds()];uniqueNameCounter+=1;return"image-"+CKEDITOR.tools.array.map(a,padNumber).join("")+"-"+uniqueNameCounter+"."+b};